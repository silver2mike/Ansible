// Actions with Production AWS Infrastructure (validate/plan/apply/destroy)

pipeline {
	agent {label 'Ansible'}
	parameters {
		choice choices: ['validate', 'plan', 'build', 'destroy'], name: "CHOICE"
  	}
	environment {
    		ANSIBLE_PK = credentials('AWS-ProdServer-private-key')
	}
  	stages {
// 		Terraform apply
		stage('AWS Env Provisioning by Terraform') {
			when {
       	    	expression { 
       		 		return params.CHOICE == 'build'
				}
        	}	

    		steps {
        		withCredentials([[
         		$class:            'AmazonWebServicesCredentialsBinding', 
	     		credentialsId:     'AWS_Terraform', 
    	  		accessKeyVariable: 'AWS_ACCESS_KEY_ID', 
      			secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
	        		sh '''
            		terraform init
           			terraform apply --auto-approve
           			sleep 60
					'''
	       		}
     		}
		}
// 		Ansible playbook with dynamic inventory
		stage('Update ProdServer, install and run Docker by Ansible') {
    		steps {
        		withCredentials([[
         		$class:            'AmazonWebServicesCredentialsBinding', 
	     		credentialsId:     'AWS_EC2_Inventory', 
    	  		accessKeyVariable: 'AWS_ACCESS_KEY_ID', 
      			secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
	        		sh '''
           			ansible-playbook --private-key=$ANSIBLE_PK -i aws_ec2.yaml prod.yml
					'''
	       		}
     		}
		}
//		Terraform destroy		
		stage('AWS Env destroy by Terraform') {
			when {
               	expression { 
           			return params.CHOICE == 'destroy'
               	}
			}
      		steps {
        		withCredentials([[
          		$class:            'AmazonWebServicesCredentialsBinding', 
          		credentialsId:     'AWS_Terraform', 
          		accessKeyVariable: 'AWS_ACCESS_KEY_ID', 
          		secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
            		sh '''
            		terraform init
            		terraform ${CHOICE} --auto-approve
            		'''          
        		}
			}
		}
//		Terraform other actions
    	stage('AWS Env Test by Terraform') {
			when {
               	expression { 
           			return params.CHOICE != 'build'
               	}
			}
      		steps {
        		withCredentials([[
          		$class:            'AmazonWebServicesCredentialsBinding', 
          		credentialsId:     'AWS_Terraform', 
          		accessKeyVariable: 'AWS_ACCESS_KEY_ID', 
          		secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
            		sh '''
            		terraform init
            		terraform ${CHOICE}
            		'''          
        		}
			}
		}	
	}
}		
